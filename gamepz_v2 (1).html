<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yama Puzzle — Enhanced Demo (v2)</title>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pud-6136943904139283"crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#f2f6ff; --card:#ffffff; --accent:#6b5bff; --muted:#6b6b7a;
    --success:#16a34a; --danger:#ef4444; --glass: rgba(255,255,255,0.6);
  }
  [data-theme="dark"]{
    --bg:#0f1724; --card:#0b1220; --accent:#7c5cff; --muted:#98a0b3; --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  html,body{height:100%}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg),#fff);display:flex;align-items:center;justify-content:center;padding:18px;color:var(--muted)}
  .app{width:100%;max-width:1100px;border-radius:14px;overflow:hidden;box-shadow:0 20px 60px rgba(60,55,80,0.08);display:grid;grid-template-columns:1fr 360px;gap:0;background:linear-gradient(180deg,var(--card),var(--glass));}
  @media(max-width:960px){.app{grid-template-columns:1fr;}}
  .main{padding:22px;min-height:560px;position:relative;overflow:hidden}
  .side{background:linear-gradient(180deg,#faf7ff,var(--card));padding:20px;border-left:1px solid rgba(107,91,255,0.06)}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  h1{margin:0;color:var(--accent);font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .screen{position:relative;overflow:auto;padding:6px 0}
  .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(60,55,80,0.04);margin-bottom:12px;color:inherit}
  .center{display:flex;align-items:center;justify-content:center}
  .heroes{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .hero{width:130px;padding:12px;border-radius:10px;text-align:center;cursor:pointer;transform:translateY(0);transition:transform .28s,box-shadow .28s;box-shadow:0 6px 18px rgba(100,80,200,0.06);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
  .hero:hover{transform:translateY(-8px);box-shadow:0 18px 40px rgba(100,80,200,0.12)}
  .avatar{width:68px;height:68px;border-radius:50%;display:inline-grid;place-items:center;font-weight:700;color:#fff;margin-bottom:8px}
  .avatar.h1{background:linear-gradient(135deg,#ff7aa2,#ff5e7a)}
  .avatar.h2{background:linear-gradient(135deg,#7dd3fc,#38bdf8)}
  .avatar.h3{background:linear-gradient(135deg,#b78bff,#6b5bff)}
  .avatar.h4{background:linear-gradient(135deg,#ffd86b,#ffb86b)}
  .hero-title{font-weight:800;color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  .btn{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(107,91,255,0.12)}
  .levels{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:12px}
  .lvl{padding:10px;border-radius:8px;border:1px dashed #f0ecff;background:linear-gradient(180deg,#fff,#fcfbff);text-align:center;cursor:pointer;transition:transform .18s,box-shadow .18s}
  .lvl:hover{transform:translateY(-6px);box-shadow:0 12px 30px rgba(100,80,200,0.06)}
  .lvl.locked{opacity:0.45;cursor:not-allowed}
  .play-area{padding:18px}
  .riddle{font-size:18px;line-height:1.5;min-height:90px;color:var(--muted)}
  .controls{display:flex;gap:8px;margin-top:12px;align-items:center}
  input[type="text"]{padding:10px;border-radius:8px;border:1px solid #eee;flex:1}
  .status{margin-top:12px;font-weight:700;color:var(--muted)}
  .small{font-size:13px;color:var(--muted)}
  .timer{font-weight:700;color:var(--accent)}
  .shake{animation:shake .6s}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
  .fadeIn{animation:fadeIn .5s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .slideIn{animation:slideIn .55s cubic-bezier(.2,.9,.3,1) both}
  @keyframes slideIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  .success-glow{box-shadow:0 8px 40px rgba(20,160,80,0.12);border:1px solid rgba(20,160,80,0.08)}
  .top-row{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .leader{max-height:320px;overflow:auto;padding-left:0;margin:0}
  .leader li{list-style:none;padding:8px 0;border-bottom:1px dashed #f0ecff;display:flex;justify-content:space-between}
  footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
  .badge{display:inline-block;padding:4px 8px;border-radius:8px;background:#f6f5ff;color:var(--accent);font-weight:700;font-size:12px}
  .theme-picker{display:flex;gap:8px;align-items:center}
  .theme-swatch{width:28px;height:28px;border-radius:6px;border:1px solid rgba(0,0,0,0.08);cursor:pointer}
  .score{font-weight:800;color:var(--accent);font-size:16px}
  .mini{font-size:12px;color:var(--muted)}
  @media(max-width:520px){.levels{grid-template-columns:repeat(3,1fr)}.hero{width:100%}}
</style>
</head>
<body data-theme="light">
  <div class="app" id="appRoot">
    <div class="main">
      <header>
        <div>
          <h1>Yama Puzzle — Enhanced v2</h1>
          <div class="sub">More levels, audio, scoring, themes, heroes, and cloud-ready scaffold.</div>
        </div>
        <div style="text-align:right">
          <div class="small">Local save + optional cloud leaderboard (configurable)</div>
          <div style="margin-top:6px"><span class="score" id="playerScore">Score: 0</span></div>
        </div>
      </header>

      <div id="screens" class="screen">
        <!-- Hero select -->
        <div id="screen-heroes" class="fadeIn">
          <div class="card center">
            <div style="width:100%">
              <div style="text-align:center;margin-bottom:8px">
                <strong>Select a Heroine / Hero</strong>
                <div class="small">Each character has a special passive and an active ability.</div>
              </div>
              <div class="heroes" id="heroesContainer"></div>
              <div style="text-align:center;margin-top:12px">
                <button id="startBtn" class="btn" disabled>Start Game</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <strong>Levels (15)</strong>
              <div class="small">Complete levels to unlock next</div>
            </div>
            <div class="levels" id="levelsGrid" style="margin-top:12px"></div>
          </div>
        </div>

        <!-- Play -->
        <div id="screen-play" style="display:none">
          <div class="card play-area slideIn">
            <div class="top-row">
              <div>
                <div class="small">Hero: <span id="heroName" class="badge"></span></div>
                <div class="small">Level <span id="levelNumber">1</span> • <span id="levelDiff" class="small"></span></div>
              </div>
              <div style="text-align:right">
                <div class="small">Time left: <span id="timer" class="timer">--</span></div>
                <div class="small">Hints: <span id="hintsLeft">0</span> • Skips: <span id="skipsLeft">0</span></div>
                <div class="mini">Streak: <span id="streak">0</span></div>
              </div>
            </div>

            <div style="margin-top:12px">
              <div class="riddle" id="riddleText"></div>
              <div class="small" style="margin-top:8px" id="levelExtra"></div>
            </div>

            <div class="controls">
              <input id="answerInput" placeholder="Type your answer..." autocomplete="off" />
              <button id="checkBtn" class="btn">Check</button>
              <button id="hintBtn" class="btn ghost">Use Hint</button>
              <button id="abilityBtn" class="btn ghost">Use Ability</button>
              <button id="skipBtn" class="btn ghost">Skip</button>
            </div>

            <div id="status" class="status"></div>
          </div>

          <div class="card small">
            <div><strong>Navigation</strong></div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="backToSelect" class="btn ghost">Back to select</button>
              <button id="nextLevelBtn" class="btn" style="display:none">Next Level</button>
            </div>
          </div>
        </div>

        <!-- Result -->
        <div id="screen-result" style="display:none">
          <div class="card center slideIn" style="padding:26px">
            <div id="resultTitle" style="font-size:20px;font-weight:800;margin-bottom:8px"></div>
            <div id="resultText" class="small" style="margin-bottom:14px"></div>
            <div style="display:flex;gap:8px">
              <button id="replayBtn" class="btn">Play Again</button>
              <button id="toSelectBtn" class="btn ghost">Level Select</button>
            </div>
          </div>
        </div>

      </div>

      <footer>Built by Joe + Latfi — Yama Enhanced v2</footer>
    </div>

    <aside class="side">
      <div class="card">
        <strong>Progress</strong>
        <div class="small" style="margin-top:8px" id="progressInfo">No levels solved yet.</div>
        <div style="margin-top:6px" class="small">Player: <span id="playerNameMini">Guest</span></div>
      </div>

      <div class="card">
        <strong>Leaderboard (local)</strong>
        <ol id="leaderList" class="leader"></ol>
        <div style="margin-top:8px" class="small">Times and scores stored locally. You can enable cloud later.</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="exportBtn" class="btn ghost small">Export Save</button>
          <button id="importBtn" class="btn ghost small">Import Save</button>
        </div>
      </div>

      <div class="card small">
        <strong>Heroes & Abilities</strong>
        <ul style="margin-top:8px">
          <li><strong>Alia — Hint</strong>: 3 hints total + reveal 2 letters when active.</li>
          <li><strong>Zed — Skip</strong>: 2 skips total + skip with no penalty.</li>
          <li><strong>Mina — Time</strong>: +45 seconds per level + slow-time ability (freeze -10s consumption).</li>
          <li><strong>Rex — Double Points</strong>: +25% points per correct, ability grants x2 points once.</li>
        </ul>
      </div>

      <div class="card small">
        <strong>Themes</strong>
        <div class="theme-picker" style="margin-top:8px">
          <div class="theme-swatch" id="themeLight" title="Light" style="background:#f6f7ff"></div>
          <div class="theme-swatch" id="themeDark" title="Dark" style="background:#0b1220"></div>
          <div class="small" style="margin-left:8px">Toggle</div>
        </div>
      </div>

      <div class="card small">
        <strong>Quick actions</strong>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="resetAll" class="btn ghost">Reset Progress</button>
          <button id="clearLeaders" class="btn ghost">Clear Leaders</button>
          <button id="enableCloud" class="btn">Cloud Setup</button>
        </div>
      </div>

    </aside>
  </div>

<script>
(() => {
  // ========== Data ==========
  const levels = [
    // 15 levels: increasing difficulty
    { id:1, diff:'Easy', text:'I speak without a mouth and hear without ears. I have nobody, but I come alive with wind. What am I?', answer:['echo'], hint:'It repeats what you say.' },
    { id:2, diff:'Easy', text:'Unscramble: "EARHT" — common English word?', answer:['earth','heart'], hint:'Planet or organ.' },
    { id:3, diff:'Easy', text:'What has keys but can’t open locks?', answer:['piano','keyboard'], hint:'It plays music.' },
    { id:4, diff:'Easy+', text:'What comes once in a minute, twice in a moment, but never in a thousand years?', answer:['m','the letter m'], hint:'Think letters.' },
    { id:5, diff:'Medium', text:'3L and 5L jugs: measure exactly 4 liters. (short answer)', answer:['fill 5 pour into 3 leaving 2 then empty 3 pour 2 into 3 fill 5 pour into 3 until 3 leaving 4','use 5 and 3 to get 4'], hint:'Use the 5L jug.' },
    { id:6, diff:'Medium', text:'What has cities but no houses, forests but no trees, and rivers but no water?', answer:['map'], hint:'It represents places.' },
    { id:7, diff:'Medium+', text:'I have branches, but no fruit, trunk or leaves. What am I?', answer:['bank','a bank'], hint:'You might keep money here.' },
    { id:8, diff:'Medium+', text:'Unscramble: "SLEET" — a common word?', answer:['steel','stele','settle'], hint:'Also a strong metal.' },
    { id:9, diff:'Hard', text:'There are three switches outside a closed room... find the right switch with one entry.', answer:['use heat and light','turn switch1 on wait off switch2 on enter check warm+lit','use heat and light to distinguish bulbs'], hint:'Use both heat and light.' },
    { id:10, diff:'Hard', text:'You see a boat filled with people — it has not sunk, but when you look again you don’t see a single person on the boat. Why?', answer:['all married','they were all married','everyone was married'], hint:'Play on the word "single".' },
    { id:11, diff:'Hard', text:'Riddle: Two fathers and two sons spent the day fishing... they only caught three fish. How is this possible?', answer:['grandfather father son','they are grandfather father and son','grandfather'], hint:'Family tree.' },
    { id:12, diff:'Hard', text:'What number comes next: 1,11,21,1211,111221,... ?', answer:['312211','look-and-say sequence','312211'], hint:'It is the “look-and-say” sequence.' },
    { id:13, diff:'Expert', text:'I am not alive, but I grow; I don’t have lungs, but I need air; what am I?', answer:['fire'], hint:'It grows and needs oxygen.' },
    { id:14, diff:'Expert', text:'A man pushes his car to a hotel and loses his fortune. How?', answer:['monopoly','he landed on monopoly','playing monopoly'], hint:'It’s a board game.' },
    { id:15, diff:'Master', text:'I turn once, what is out will not get in. I turn again, what is in will not get out. What am I?', answer:['key','a key'], hint:'A small metal tool.' },
  ];

  const heroes = [
    { id:'alia', name:'Alia', desc:'3 hints • Reveal 2 letters (ability)', avatarClass:'h1', uses:{hints:3,skips:0,extraTime:0}, abilityName:'Reveal 2 letters', ability:'revealLetters' },
    { id:'zed', name:'Zed', desc:'2 skips • Free skip ability', avatarClass:'h2', uses:{hints:0,skips:2,extraTime:0}, abilityName:'Free Skip', ability:'freeSkip' },
    { id:'mina', name:'Mina', desc:'+45s • Freeze time ability', avatarClass:'h3', uses:{hints:0,skips:0,extraTime:45}, abilityName:'Freeze (-10s cost)', ability:'freezeTime' },
    { id:'rex', name:'Rex', desc:'+25% points • Double points once', avatarClass:'h4', uses:{hints:0,skips:0,extraTime:0}, abilityName:'Double Points', ability:'doublePoints' },
  ];

  // ========== Storage and State ==========
  const STORAGE_KEY = 'yama_enh_v2_save';
  let state = {
    playerName: 'Guest',
    selectedHero: null,
    solved: [],
    leaders: [], // {name, level, score, timeSec, ts}
    heroUsages: { hintsLeft:0, skipsLeft:0, extraTime:0 },
    currentLevel: null,
    timer: null,
    timeLeft: 0,
    startTimestamp: null,
    score: 0,
    streak: 0,
    abilityUsed: {}, // {levelId: true}
    theme: 'light'
  };

  // ========== DOM ==========
  const heroesContainer = document.getElementById('heroesContainer');
  const startBtn = document.getElementById('startBtn');
  const levelsGrid = document.getElementById('levelsGrid');
  const screenHeroes = document.getElementById('screen-heroes');
  const screenPlay = document.getElementById('screen-play');
  const screenResult = document.getElementById('screen-result');
  const heroNameBadge = document.getElementById('heroName');
  const levelNumberEl = document.getElementById('levelNumber');
  const riddleText = document.getElementById('riddleText');
  const levelDiff = document.getElementById('levelDiff');
  const answerInput = document.getElementById('answerInput');
  const checkBtn = document.getElementById('checkBtn');
  const hintBtn = document.getElementById('hintBtn');
  const skipBtn = document.getElementById('skipBtn');
  const abilityBtn = document.getElementById('abilityBtn');
  const statusEl = document.getElementById('status');
  const timerEl = document.getElementById('timer');
  const hintsLeftEl = document.getElementById('hintsLeft');
  const skipsLeftEl = document.getElementById('skipsLeft');
  const backToSelect = document.getElementById('backToSelect');
  const nextLevelBtn = document.getElementById('nextLevelBtn');
  const progressInfo = document.getElementById('progressInfo');
  const leaderList = document.getElementById('leaderList');
  const resetAll = document.getElementById('resetAll');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const replayBtn = document.getElementById('replayBtn');
  const toSelectBtn = document.getElementById('toSelectBtn');
  const resultTitle = document.getElementById('resultTitle');
  const resultText = document.getElementById('resultText');
  const playerScoreEl = document.getElementById('playerScore');
  const playerNameMini = document.getElementById('playerNameMini');
  const streakEl = document.getElementById('streak');

  const themeLight = document.getElementById('themeLight');
  const themeDark = document.getElementById('themeDark');
  const enableCloudBtn = document.getElementById('enableCloud');
  const clearLeadersBtn = document.getElementById('clearLeaders');

  // ========== Audio (WebAudio simple sounds) ==========
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new AudioCtx(); }
  function playBeep(freq=440, time=0.08, gain=0.06){ try{ ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type='sine'; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+time); }catch(e){} }
  let musicOsc = null;
  let musicPlaying = false;
  function startMusic(){ try{ if(musicPlaying) return; ensureAudio(); musicOsc = audioCtx.createOscillator(); const g = audioCtx.createGain(); musicOsc.type='sine'; musicOsc.frequency.value=220; g.gain.value=0.02; musicOsc.connect(g); g.connect(audioCtx.destination); musicOsc.start(); musicPlaying = true; }catch(e){} }
  function stopMusic(){ try{ if(musicOsc) musicOsc.stop(); musicOsc = null; musicPlaying = false; }catch(e){} }

  // ========== Utils ==========
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{ Object.assign(state, JSON.parse(raw)); }catch(e){}
    }
    if(!state.heroUsages) state.heroUsages={hintsLeft:0,skipsLeft:0,extraTime:0};
    if(!state.solved) state.solved=[];
    if(!state.leaders) state.leaders=[];
  }
  function scrub(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'').trim(); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  // ========== Render UI ==========
  function renderHeroes(){
    heroesContainer.innerHTML = '';
    heroes.forEach(h=>{
      const el = document.createElement('div');
      el.className = 'hero card';
      el.innerHTML = `
        <div class="avatar ${h.avatarClass}">${h.name.slice(0,2)}</div>
        <div class="hero-title">${h.name}</div>
        <div class="muted">${h.desc}</div>
      `;
      el.addEventListener('click', ()=>{
        document.querySelectorAll('.hero').forEach(n=>n.style.outline='');
        el.style.outline = '3px solid rgba(107,91,255,0.08)';
        state.selectedHero = h.id;
        state.heroUsages.hintsLeft = h.uses.hints;
        state.heroUsages.skipsLeft = h.uses.skips;
        state.heroUsages.extraTime = h.uses.extraTime || 0;
        startBtn.disabled = false;
        saveState();
        updateSide();
      });
      heroesContainer.appendChild(el);
    });
    // preselect if saved
    if(state.selectedHero){
      const idx = heroes.findIndex(h=>h.id===state.selectedHero);
      if(idx>=0 && heroesContainer.children[idx]) heroesContainer.children[idx].style.outline='3px solid rgba(107,91,255,0.08)';
      startBtn.disabled = false;
    }
  }

  function renderLevels(){
    levelsGrid.innerHTML = '';
    levels.forEach(l=>{
      const el = document.createElement('div');
      el.className = 'lvl';
      const solved = state.solved.includes(l.id);
      const unlocked = (l.id === 1) || state.solved.includes(l.id-1) || solved;
      if(!unlocked) el.classList.add('locked');
      el.innerHTML = `<div style="font-weight:800">L${l.id}</div><div class="small">${l.diff}</div><div style="margin-top:6px">${solved?'<span class="badge">Solved</span>':''}</div>`;
      el.addEventListener('click', ()=>{ if(!unlocked){ flash(el); return;} openLevel(l.id); });
      levelsGrid.appendChild(el);
    });
  }

  function updateSide(){
    // progress
    if(state.solved.length === 0) progressInfo.textContent = 'No levels solved yet.';
    else progressInfo.textContent = `Solved ${state.solved.length} / ${levels.length} levels: ${state.solved.join(', ')}`;
    // leader
    leaderList.innerHTML = '';
    if(state.leaders.length === 0) leaderList.innerHTML = '<li class="small">No local records yet</li>';
    else {
      state.leaders.slice(0,8).forEach(r=>{
        const li = document.createElement('li');
        li.innerHTML = `<span>${escapeHtml(r.name||'Player')}</span><span>${r.score}pts • ${r.timeSec || 0}s (L${r.level})</span>`;
        leaderList.appendChild(li);
      });
    }
    hintsLeftEl.textContent = state.heroUsages.hintsLeft || 0;
    skipsLeftEl.textContent = state.heroUsages.skipsLeft || 0;
    playerScoreEl.textContent = 'Score: ' + (state.score || 0);
    playerNameMini.textContent = escapeHtml(state.playerName || 'Guest');
    streakEl.textContent = state.streak || 0;
    document.body.setAttribute('data-theme', state.theme || 'light');
  }

  function flash(el){ el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'),700); }

  // ========== Gameplay ==========
  function openLevel(id){
    const lvl = levels.find(l=>l.id===id);
    if(!lvl) return;
    state.currentLevel = id;
    const hero = heroes.find(h=>h.id===state.selectedHero);
    heroNameBadge.textContent = hero ? hero.name : '—';
    levelNumberEl.textContent = lvl.id;
    levelDiff.textContent = lvl.diff;
    riddleText.textContent = lvl.text;
    answerInput.value = '';
    statusEl.textContent = '';
    // base time
    let base = 90;
    if(lvl.diff.includes('Easy')) base = 60;
    if(lvl.diff.includes('Medium')) base = 120;
    if(lvl.diff.includes('Hard')) base = 180;
    if(lvl.diff.includes('Expert')) base = 240;
    if(lvl.diff.includes('Master')) base = 320;
    state.timeLeft = base + (state.heroUsages.extraTime || 0);
    state.startTimestamp = Date.now();
    screenHeroes.style.display = 'none';
    screenPlay.style.display = '';
    screenResult.style.display = 'none';
    hintsLeftEl.textContent = state.heroUsages.hintsLeft || 0;
    skipsLeftEl.textContent = state.heroUsages.skipsLeft || 0;
    startTimer();
    saveState();
    startMusic();
  }

  function startTimer(){
    clearInterval(state.timer);
    updateTimerDisplay();
    state.timer = setInterval(()=>{
      state.timeLeft--;
      updateTimerDisplay();
      if(state.timeLeft <= 0){ clearInterval(state.timer); onTimeOut(); }
    },1000);
  }

  function updateTimerDisplay(){ timerEl.textContent = state.timeLeft + 's'; if(state.timeLeft<=10) timerEl.style.color='var(--danger)'; else timerEl.style.color='var(--accent)'; }

  function onTimeOut(){
    statusEl.style.color='var(--danger)';
    statusEl.textContent = 'Time\'s up! Level failed.';
    playBeep(220,0.18,0.08);
    document.querySelector('.play-area').classList.add('shake');
    setTimeout(()=>document.querySelector('.play-area').classList.remove('shake'),700);
    // reset streak
    state.streak = 0;
    updateSide();
    nextLevelBtn.style.display = 'none';
    stopMusic();
  }

  function checkAnswer(){
    const lvl = levels.find(l=>l.id===state.currentLevel); if(!lvl) return;
    const raw = answerInput.value || ''; if(!raw.trim()){ statusEl.style.color='var(--danger)'; statusEl.textContent='Write an answer.'; playBeep(220); return; }
    const candidate = scrub(raw);
    const matches = lvl.answer.some(a => scrub(a) === candidate || scrub(a).includes(candidate) || candidate.includes(scrub(a)));
    if(matches){
      clearInterval(state.timer);
      playBeep(880,0.08,0.08);
      statusEl.style.color='var(--success)';
      const elapsed = Math.round((Date.now()-state.startTimestamp)/1000);
      statusEl.textContent = `Correct! Solved in ${elapsed}s.`;
      document.querySelector('.play-area').classList.add('success-glow');
      setTimeout(()=>document.querySelector('.play-area').classList.remove('success-glow'),1000);
      // scoring: base points by difficulty + time bonus + streak bonus
      let basePoints = 50;
      if(lvl.diff.includes('Easy')) basePoints = 40;
      if(lvl.diff.includes('Easy+')) basePoints = 50;
      if(lvl.diff.includes('Medium')) basePoints = 80;
      if(lvl.diff.includes('Medium+')) basePoints = 100;
      if(lvl.diff.includes('Hard')) basePoints = 160;
      if(lvl.diff.includes('Expert')) basePoints = 220;
      if(lvl.diff.includes('Master')) basePoints = 320;
      const timeBonus = Math.max(0, Math.round((state.timeLeft/ (state.timeLeft + elapsed + 1)) * 50));
      state.streak = (state.streak || 0) + 1;
      let streakBonus = Math.min(50, state.streak * 5);
      // hero Rex double points ability
      const hero = heroes.find(h=>h.id===state.selectedHero);
      let points = basePoints + timeBonus + streakBonus;
      if(hero && hero.id === 'rex'){
        points = Math.round(points * 1.25);
      }
      // if doublePoints ability active for this level
      if(state.abilityUsed[state.currentLevel]) points = points * 2;
      state.score = (state.score || 0) + points;
      // mark solved
      if(!state.solved.includes(lvl.id)) state.solved.push(lvl.id);
      // prompt name for leaderboard
      setTimeout(()=>{
        const name = prompt('Enter your name for local leaderboard (optional)', state.playerName) || state.playerName || 'Player';
        state.playerName = name.substring(0,20);
        state.leaders.push({ name: state.playerName, level: lvl.id, score: state.score, timeSec: elapsed, ts: Date.now() });
        state.leaders.sort((a,b)=>b.score - a.score || a.timeSec - b.timeSec);
        saveState();
        updateSide();
        // next or finish
        if(lvl.id === levels.length){ showResult(true, elapsed); } else { nextLevelBtn.style.display = ''; }
        renderLevels();
      },400);
      stopMusic();
    } else {
      statusEl.style.color='var(--danger)';
      statusEl.textContent='Wrong answer — try again.';
      playBeep(200,0.08,0.08);
      document.querySelector('.play-area').classList.add('shake');
      setTimeout(()=>document.querySelector('.play-area').classList.remove('shake'),700);
      state.streak = 0;
      updateSide();
    }
    saveState();
  }

  function useHint(){
    const lvl = levels.find(l=>l.id===state.currentLevel); if(!lvl) return;
    if((state.heroUsages.hintsLeft||0) <= 0){ alert('No hints left.'); return; }
    state.heroUsages.hintsLeft--;
    saveState();
    updateSide();
    // reveal simple hint: show existing lvl.hint
    alert('Hint: ' + lvl.hint);
    playBeep(600,0.06,0.03);
  }

  function doSkip(){
    const lvl = levels.find(l=>l.id===state.currentLevel); if(!lvl) return;
    if((state.heroUsages.skipsLeft||0) <= 0){ alert('No skips left.'); return; }
    if(!confirm('Skip this level? This will mark it as solved.')) return;
    state.heroUsages.skipsLeft--;
    if(!state.solved.includes(lvl.id)) state.solved.push(lvl.id);
    saveState();
    updateSide();
    renderLevels();
    clearInterval(state.timer);
    playBeep(440,0.08,0.04);
    if(lvl.id === levels.length) showResult(true,0,true); else openLevel(lvl.id+1);
  }

  // ========== Abilities ==========
  function useAbility(){
    const hero = heroes.find(h=>h.id===state.selectedHero);
    const lvl = levels.find(l=>l.id===state.currentLevel);
    if(!hero || !lvl){ alert('Choose hero and level'); return; }
    if(state.abilityUsed[state.currentLevel]){ alert('Ability already used on this level.'); return; }
    // abilities implementations
    if(hero.ability === 'revealLetters'){
      // reveal two letters at random positions
      const answers = lvl.answer[0] || '';
      const core = answers.replace(/[^a-z0-9]/gi,'');
      if(core.length < 2){ alert('Cannot reveal letters.'); return; }
      // reveal by showing in status
      let idx1 = Math.floor(Math.random()*core.length);
      let idx2 = Math.floor(Math.random()*core.length);
      while(idx2===idx1) idx2 = Math.floor(Math.random()*core.length);
      const letters = `${core[idx1]} and ${core[idx2]}`;
      alert('Revealed letters: ' + letters);
      state.abilityUsed[state.currentLevel] = true;
      state.score += 5;
      playBeep(1000,0.06,0.06);
    } else if(hero.ability === 'freeSkip'){
      if((state.heroUsages.skipsLeft||0) <= 0){ alert('No free skips left.'); return; }
      if(!confirm('Use free skip now?')) return;
      state.heroUsages.skipsLeft--;
      state.abilityUsed[state.currentLevel] = true;
      if(!state.solved.includes(lvl.id)) state.solved.push(lvl.id);
      saveState();
      renderLevels();
      openLevel(lvl.id+1);
    } else if(hero.ability === 'freezeTime'){
      // cost: -10 seconds from total of ability's uses - implement as consume 10s from "bank" if available
      if(state.timeLeft <= 12){ alert('Not enough time to freeze.'); return; }
      // freeze for 8 seconds (no countdown), cost 10 seconds from remaining
      const freezeDuration = 8;
      state.timeLeft = Math.max(0, state.timeLeft - 10);
      clearInterval(state.timer);
      updateTimerDisplay();
      const prevText = riddleText.textContent;
      riddleText.textContent = prevText + ' (Time frozen...)';
      playBeep(1200,0.12,0.04);
      setTimeout(()=>{
        riddleText.textContent = prevText;
        startTimer();
      }, freezeDuration*1000);
      state.abilityUsed[state.currentLevel] = true;
    } else if(hero.ability === 'doublePoints'){
      // enable double points for this level (one-time)
      state.abilityUsed[state.currentLevel] = true;
      alert('Double points activated for this level!');
      playBeep(1400,0.06,0.05);
    }
    saveState();
    updateSide();
  }

  // ========== Results/Flow ==========
  function showResult(completed, timeSec=0, skipped=false){
    screenHeroes.style.display='none'; screenPlay.style.display='none'; screenResult.style.display='';
    if(completed){
      resultTitle.textContent = skipped? 'Level skipped!' : 'All done — Demo finished!';
      resultText.textContent = skipped ? 'You skipped the final level.' : `You completed the demo. Final score: ${state.score}pts.`;
    } else {
      resultTitle.textContent = 'Session ended';
      resultText.textContent = 'Come back later.';
    }
    stopMusic();
  }

  // ========== Events ==========
  startBtn.addEventListener('click', ()=>{
    if(!state.selectedHero){ alert('Pick a hero first'); return; }
    const next = levels.find(l=>!state.solved.includes(l.id)) || levels[levels.length-1];
    openLevel(next.id);
  });
  checkBtn.addEventListener('click', checkAnswer);
  answerInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') checkAnswer(); });
  hintBtn.addEventListener('click', useHint);
  skipBtn.addEventListener('click', doSkip);
  abilityBtn.addEventListener('click', useAbility);
  backToSelect.addEventListener('click', ()=>{
    screenHeroes.style.display=''; screenPlay.style.display='none'; screenResult.style.display='none';
    clearInterval(state.timer); saveState(); renderLevels(); stopMusic();
  });
  nextLevelBtn.addEventListener('click', ()=>{
    const cur = state.currentLevel;
    const next = cur+1;
    if(next > levels.length){ showResult(true); return; }
    openLevel(next); nextLevelBtn.style.display='none';
  });

  resetAll.addEventListener('click', ()=>{
    if(!confirm('Reset all progress?')) return;
    localStorage.removeItem(STORAGE_KEY);
    state = { playerName:'Guest', selectedHero:null, solved:[], leaders:[], heroUsages:{hintsLeft:0,skipsLeft:0,extraTime:0}, currentLevel:null, timer:null, timeLeft:0, startTimestamp:null, score:0, streak:0, abilityUsed:{}, theme:'light' };
    init();
  });

  clearLeadersBtn.addEventListener('click', ()=>{
    if(!confirm('Clear local leaders?')) return;
    state.leaders = []; saveState(); updateSide();
  });

  exportBtn.addEventListener('click', ()=>{
    const data = JSON.stringify(state);
    try{ navigator.clipboard.writeText(data); alert('Save JSON copied to clipboard'); }catch(e){ prompt('Copy this JSON:', data); }
  });

  importBtn.addEventListener('click', ()=>{
    const raw = prompt('Paste JSON save here:');
    if(!raw) return;
    try{ const parsed = JSON.parse(raw); Object.assign(state, parsed); saveState(); init(); alert('Imported.'); }catch(e){ alert('Invalid JSON.'); }
  });

  replayBtn.addEventListener('click', ()=>{
    state.solved = []; state.leaders = []; state.score = 0; state.streak = 0; saveState(); init();
  });

  toSelectBtn.addEventListener('click', ()=>{ init(); });

  themeLight.addEventListener('click', ()=>{ state.theme='light'; updateSide(); saveState(); });
  themeDark.addEventListener('click', ()=>{ state.theme='dark'; updateSide(); saveState(); });

  enableCloudBtn.addEventListener('click', ()=>{
    alert('Cloud leaderboard is scaffolded but not enabled. To enable, provide Firebase config (we can add this later). This demo keeps everything local for privacy.');
  });

  clearLeadersBtn.addEventListener('click', ()=>{
    if(!confirm('Clear local leaderboards?')) return;
    state.leaders = []; saveState(); updateSide();
  });

  // ========== Init ==========
  function init(){
    loadState();
    renderHeroes();
    renderLevels();
    updateSide();
    screenHeroes.style.display=''; screenPlay.style.display='none'; screenResult.style.display='none';
    // set playerName from prompt optionally
    if(!state.playerName || state.playerName === 'Guest'){
      const nm = prompt('Enter player name (optional)', state.playerName || 'Guest');
      if(nm) state.playerName = nm.substring(0,20);
    }
    saveState();
  }

  // start
  init();

  // expose for debugging
  window.YamaEnhanced = { state, levels, heroes };

})();
</script>
<ins class="adsbygoogle"
style="display:block"
data-ad-solt="1234567890"
data-ad-format="auto"
data-ful-width-responsive="true"</ins>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</body>
</html>
